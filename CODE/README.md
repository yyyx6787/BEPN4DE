# A Weakly Supervised Framework for Effective and Efficient Detour Extraction on Large Trajectory Data
This is the Implementation of our paper "A Weakly Supervised Framework for Effective and Efficient Detour Extraction on Large Trajectory Data".

## Requirements

* Linux Ubuntu OS (16.04 is tested)
* Python >= 3.6 (Anaconda3 is recommended and 3.7 is tested)
* Pytorch (1.7.0 is tested)

Please refer to the source code to install the required packages that have not been installed in your environment such as matplotlib in Python for visualization. You can install these packages with conda in a shell as

```
conda install matplotlib
```

## Dataset & Preprocessing

Download & upzip the dataset [maually_detour](https://www.dropbox.com/sh/7ktjq6h3zi99wlp/AABGXzV1GnQq2JKzaYmjjkQ6a?dl=0) into the `./code` folder, which is the testing data for the work.
Preprocess the dataset to obtain the intermediate outputs by
```
python preprocessing.py
```

We dump these outputs as `chengdu.rar` for convenience, which can be upzipped into the `./code/data_roadnetwork` folder directly. Then, process training data by importing the detours via runing generate_detours.py file:
```
python generate_detours.py
```
where `ger_detour_batch` function is used to generate detours and `get_normal_route` function is used to generate normal routes. 
During this process, there are several parameters controling the detour length and the times of detour for normal routes. 

## Running Procedures 

### Direction Feature 
To get the direction feature, 
```
python token2position.py
```

### Normal Route Feature
There are several parameters in `c_span.py`, you may try to turn these parameters for a better performance when training, 
including `t = 0.3, 0.4, 0.5 or 0.6`. 
Also, there is a parameter controlling to generate the normal route feature of train dataset or test dataset.
```
python c_span.py
```

### Training and Evalation of BEPN4DE without Global Pruning

Run `train_model.py`, the generated models with best performance will be stored in the folder `./models` automatically, and you can pick the model with the best performance on the testing data as your model from them.
You can set several parameters in the training, including learning rate.
After training, the model with best performance will be performed on testing data and eval.py file is the file to test on testing data.
```
python train_model.py
python eval.py
```

### Training and Evalation of BEPN4DE with Global Pruning

First, train a binary classifier for Global Pruning
```
python classifier_back.py
```
and train the model and save the best model with global pruning.
```
python train_model.py
```
where the eval_classifier.py is needed to import at the head of the codes. eval_classifier.py is the file to test on testing data with global pruning.
```
python eval_classifier.py
```

### Prepare for BEPN4DE+
sim_for_efficiency_train.py (resp. sim_for_efficiency_val.py, sim_for_efficiency_test.py) are used to simplify the trajectory data for training (resp. valid, testing).
And para for this file is 2,3,4,5, representing every para points keep 1 point, which is local pruning.
```
python sim_for_efficiency_train.py
python sim_for_efficiency_val.py 
python sim_for_efficiency_test.py 
```
### Training and Evalation of BEPN4DE+ without Global Pruning
```
python train_model_plus.py
```
where eval.py is used to import into the train_model.py.

### Training and Evalation of BEPN4DE+ with Global Pruning

Training a binary classifier with simplification for Global Pruning, and copy the simplification val data generated by `sim_for_efficiency_val.py` into the `classfier_data` folder
```
python sim_for_efficiency_train_for_classifier.py
python classifier_back_simp.py
```
and train the model and save the best model with global pruning.
```
python train_model_plus.py
```
where eval_classifier_simp.py is used to import at the head of the codes and eval_classifier_simp.py is the file to test on testing data with local&global pruning.
```
python eval_classifier_simp.py
```
For convenience, we provide the trained BEPN4DE, BEPN4DE+ and classifier models as `models.rar`, which can be upzipped into the `./code` folder directly.

### Visualization

We provide an interface `visualization.py` to visualize the detours, you can also use it to observe the model performance during the training or comment it in the codes for your purpose. 
Note that this part is supported by matplotlib in Python 3.6.
```
python visualization.py
```
